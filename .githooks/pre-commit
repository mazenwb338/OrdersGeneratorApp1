#!/bin/bash
set -e
MAX_SIZE=${MAX_COMMIT_FILE_SIZE:-$((50 * 1024 * 1024))}
BLOCK_EXTS=("hprof")
for f in $(git diff --cached --name-only); do
  [ ! -f "$f" ] && continue
  for ext in "${BLOCK_EXTS[@]}"; do
    [[ "$f" == *.$ext ]] && { echo "ERROR: $f blocked (.$ext)"; exit 1; }
  done
  [[ "$f" == *.bundle ]] && continue
  sz=$(wc -c <"$f")
  if [ "$sz" -gt "$MAX_SIZE" ]; then
    echo "ERROR: $f > $MAX_SIZE bytes ($sz)."
    exit 1
  fi
done